ARG SCHEME=chibi
ARG IMAGE=chibi:head
FROM schemers/chicken:5 AS cache
RUN apt-get update && apt-get install -y \
    git make build-essential ca-certificates libffi-dev
WORKDIR /cache
RUN git clone https://gitea.scheme.org/Retropikzel/compile-r7rs.git --depth=1
RUN git clone https://github.com/ashinn/chibi-scheme.git --depth=1
WORKDIR /cache/chibi-scheme
RUN make
RUN make install
RUN mkdir -p ${HOME}/.snow && echo "()" > "${HOME}"/.snow/congig.scm
RUN snow-chibi install --impls=chicken --always-yes "(foreign c)"
RUN snow-chibi install --impls=chicken --always-yes "(srfi 170)"
WORKDIR /cache/compile-r7rs
RUN make build-chicken
WORKDIR /cache
RUN apt download make

ARG SCHEME=chibi
ARG IMAGE=chibi:head
FROM schemers/${IMAGE}
COPY --from=cache /cache /cache
WORKDIR /cache
RUN dpkg -i *.deb
COPY --from=cache /cache/compile-r7rs/compile-r7rs /usr/local/bin/compile-r7rs
WORKDIR /workdir
ARG SCHEME=chibi
ENV COMPILE_R7RS=${SCHEME}

