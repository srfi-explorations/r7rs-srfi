ARG SCHEME=chibi
ARG IMAGE=chibi:head
FROM debian:trixie-slim AS cache
RUN apt-get update && apt-get install -y \
    make gcc libffi-dev ca-certificates git

WORKDIR /cache
RUN git clone https://github.com/ashinn/chibi-scheme.git --depth=1
RUN git clone https://gitea.scheme.org/Retropikzel/compile-r7rs.git --depth=1

WORKDIR /cache/chibi-scheme
RUN make
RUN make install

WORKDIR /cache/compile-r7rs
RUN snow-chibi install "(foreign c)"
RUN snow-chibi install "(srfi 170)"
RUN make build-chibi


ARG SCHEME=chibi
ARG IMAGE=chibi:head
FROM schemers/${IMAGE}
RUN apt-get update && apt-get install -y make libffi-dev
RUN mkdir ${HOME}/.snow && echo "()" > ${HOME}/.snow/config.scm
COPY --from=cache /cache /cache
WORKDIR /cache/chibi-scheme
RUN make install
WORKDIR /cache/compile-r7rs
RUN make install
COPY --from=cache /usr/local/share/snow /usr/local/share/snow
COPY --from=cache /usr/local/lib/snow /usr/local/lib/snow
WORKDIR /workdir
ARG SCHEME=chibi
ENV COMPILE_R7RS=${SCHEME}

