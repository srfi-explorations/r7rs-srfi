ARG SCHEME=chibi
ARG IMAGE=chibi:head
FROM debian:trixie-slim AS build
RUN apt-get install -y git make gcc
RUN apt-get update && apt-get install \
    --download-only \
    --no-install-recommends \
    --no-install-suggests \
    -y \
    ca-certificates \
    git \
    gcc \
    libc-dev \
    make \
    libffi-dev \
    cmark \
    time \
    bc \
    gauche
WORKDIR /cache/debs
RUN cp -r /var/cache/apt/archives/*.deb .
WORKDIR /cache
RUN git clone https://github.com/ashinn/chibi-scheme.git --depth=1
WORKDIR /cache/chibi-scheme
RUN make

ARG SCHEME=chibi
ARG IMAGE=chibi:head
FROM schemers/${IMAGE}
RUN apt-get update && apt-get install -y make
COPY --from=build /cache /cache
WORKDIR /cache/debs
RUN dpkg -i *.deb
WORKDIR /cache/chibi
RUN make install
WORKDIR /workdir
COPY --from=retropikzel1/compile-r7rs /opt/compile-r7rs /opt/compile-r7rs
RUN /opt/compile-r7rs/bin/install-docker
ARG SCHEME=chibi
ENV COMPILE_R7RS=${SCHEME}

