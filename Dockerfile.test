ARG SCHEME=chibi
ARG IMAGE=chibi:head
FROM debian:trixie AS cache
RUN apt-get update && apt-get install -y git make ca-certificates
WORKDIR /cache
RUN git clone https://codeberg.org/retropikzel/compile-scheme.git --depth=1
WORKDIR /cache/compile-scheme
RUN make build-gauche
WORKDIR /cache
RUN apt download make gauche libgauche-0.98-0 libmbedtls21 libmbedcrypto16 libmbedx509-7

ARG SCHEME=chibi
ARG IMAGE=chibi:head
FROM schemers/${IMAGE}
RUN mkdir -p ${HOME}/.snow && echo "()" > "${HOME}"/.snow/congig.scm
COPY --from=cache /cache /cache
WORKDIR /cache
RUN dpkg -i *.deb
WORKDIR /cache/compile-scheme
RUN make install
WORKDIR /workdir
ARG SCHEME=chibi
ENV COMPILE_R7RS=${SCHEME}
COPY srfi-test srfi-test
COPY Makefile .
COPY srfi srfi

